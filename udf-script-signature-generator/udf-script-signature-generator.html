<html>
<head><title>Exasol UDF-Script Signature Generator</title>
<script type="text/javascript">
function generate_sql(obj) {
language = document.getElementById('language_lua').checked ? "LUA" : document.getElementById('language_java').checked ? "JAVA" : document.getElementById('language_r').checked ? "R" : "PYTHON";
scalar_set = document.getElementById('input_set').checked ? "SET" : "SCALAR";
name = document.getElementById('name').value;
parameters = document.getElementsByName('parameters');
parameter_types = document.getElementsByName('parameter_types');
returns_emits = document.getElementById('output_emits').checked ? "EMITS" : "RETURNS";
returns = document.getElementById('returns').value;
emits_cols = document.getElementsByName('emits_cols');
emits_types = document.getElementsByName('emits_types');
variadic_input = document.getElementById('variadic_input');
variadic_output = document.getElementById('variadic_output');

if(name == '') {
 document.getElementById('name').style.borderColor = 'red';
} else {
 document.getElementById('name').style.borderColor  = '';
}
if(returns == '') {
 document.getElementById('returns').style.borderColor = 'red';
} else if(language=='LUA' && (returns.toUpperCase() == 'DATE' || returns.toUpperCase() == 'TIMESTAMP')) {
 document.getElementById('returns').style.borderColor = 'red';
} else {
 document.getElementById('returns').style.borderColor  = '';
}

for(i=0; i<parameters.length;i++) {
 if(parameters[i].value=='') { 
  parameters[i].style.borderColor = 'red';
 } else {
  parameters[i].style.borderColor = '';
 }
 
 if (parameter_types[i].value=='') {
  parameter_types[i].style.borderColor = 'red';
 }
 else if(language=='LUA' && (parameter_types[i].value.toUpperCase() == 'DATE' || parameter_types[i].value.toUpperCase() == 'TIMESTAMP')) {
  parameter_types[i].style.borderColor = 'red';
 } else {
  parameter_types[i].style.borderColor = '';
 }
}
for(i=0; i<emits_cols.length;i++) {
 if(emits_cols[i].value=='') { 
  emits_cols[i].style.borderColor = 'red';
 } else {
  emits_cols[i].style.borderColor = '';
 }
 
 if (emits_types[i].value=='') {
  emits_types[i].style.borderColor = 'red';
 }
 else if(language=='LUA' && (emits_types[i].value.toUpperCase() == 'DATE' || emits_types[i].value.toUpperCase() == 'TIMESTAMP')) {
  emits_types[i].style.borderColor = 'red';
 } else {
  emits_types[i].style.borderColor = '';
 }
}





if (scalar_set == 'SET' && parameters.length==0) {
 add_parameter();
}

if(obj.id=='scalar_set' && obj.value=='SCALAR' && parameters.length==1 && parameters[0].value=='' && parameter_types[0].value=='') {
 remove_li(parameters[0].parentNode);
}

if(returns_emits == 'RETURNS') {
 document.getElementById('li_returns').style.display = "list-item";
 document.getElementById('li_emits').style.display = "none";
}

if(returns_emits == 'EMITS') {
 document.getElementById('li_returns').style.display = "none";
 document.getElementById('li_emits').style.display = "list-item";
}

if(variadic_input.checked) {
 document.getElementById('ul_parameters').style.display = "none";
} else {
 document.getElementById('ul_parameters').style.display = "block";
}

if(variadic_output.checked) {
 document.getElementById('ul_emits_cols').style.display = "none";
} else {
 document.getElementById('ul_emits_cols').style.display = "block";
}


sql = '--/\n'
sql += 'CREATE OR REPLACE '+language+' '+scalar_set+' SCRIPT '+name+'(';

if(variadic_input.checked) {
 sql += '...';
} else {
 for(i=0; i<parameters.length;i++) {
   if (i>=1) { sql += ', ' }
   sql += parameters[i].value+' '+parameter_types[i].value;
 }
}

sql += ') \n'+returns_emits;
if(returns_emits == 'RETURNS') {
 sql += ' '+returns;
} else {
 sql += '('
 if(variadic_output.checked) {
  sql += '...';
 } else {
  for(i=0; i<emits_cols.length;i++) {
   if (i>=1) { sql += ', ' }
   sql += emits_cols[i].value+' '+emits_types[i].value;
  }
 }
 sql += ')'
}

sql += ' AS \n';

if (language=="LUA") {
 sql += 'function run(ctx)\n';
 sql += ' -- TODO: implement script\n'
 if(scalar_set=="SET") {
  sql += ' repeat       -- loop over input\n';
  sql += '  '+parameters[0].value+' = ctx.'+parameters[0].value+'     -- access input variable\n';
  sql += ' until not ctx.next()\n';
 } else if (parameters.length>=1) {
   sql += ' '+parameters[0].value+' = ctx.'+parameters[0].value+'     -- access input variable\n';
 }
 if(returns_emits=="RETURNS") {
  sql += ' return NULL\n';
 } else {
  sql += ' ctx.emit(NULL'+(', NULL'.repeat(emits_cols.length-1))+')\n';
 }
 sql += 'end\n';
}

if(language=="PYTHON") {
 sql += 'def run(ctx):\n';
 sql += ' ## TODO: implement script\n';
 if (scalar_set=="SET") {
  sql += ' while True:     ## loop over input\n';
  sql += '  '+parameters[0].value+' = ctx.'+parameters[0].value+'      ## access input variable\n';
  sql += '  if not ctx.next(): break\n';
 } else if (parameters.length>=1) {
  sql += ' '+parameters[0].value+' = ctx.'+parameters[0].value+'      ## access input variable\n';
 }
 if (returns_emits=="RETURNS") {
  sql += ' return None\n';
 } else {
  sql += ' ctx.emit(None'+(', None'.repeat(emits_cols.length-1))+')\n';
 }
}

if (language=="R") { 
 sql += 'run <- function(ctx) {\n';
 sql += ' ## TODO: implement script\n';
 if(scalar_set=="SET") {
  sql += ' repeat {       ## loop over input\n';
  sql += '  '+parameters[0].value+' <- ctx$'+parameters[0].value+'     ## access input variable\n';
  sql += '  if (!(ctx$next_row())){break}\n';
  sql += ' }\n';
 } else if(parameters.length>=1) {
  sql += ' '+parameters[0].value+' <- ctx$'+parameters[0].value+'     ## access input variable\n';
 }
 if(returns_emits=="RETURNS") {
  sql += ' NA\n';
 } else {
  sql += ' ctx$emit(NA'+(', NA'.repeat(emits_cols.length-1))+')\n';
 }
 sql += '}\n';
}

if(language=="JAVA") {
 if(returns_emits == "RETURNS") {
  return_type = returns.toLowerCase();
  if(return_type == "date") { return_type = 'java.sql.Date'; }
  else if(return_type.indexOf('char')>-1) { return_type = 'String'; }
  else if(return_type == 'int') { return_type = 'Integer'; }
  else if(return_type == 'double') { return_type = 'Double'; }
  else { return_type = return_type.substr(0,1).toUpperCase()+return_type.substr(1); }
 } else {
  return_type = 'void';
 }

 sql += 'class '+name.toUpperCase()+' {\n';
 sql += ' static '+return_type+' run(ExaMetadata exa, ExaIterator ctx) throws Exception {\n';
 
 sql += ' // TODO: implement script\n';

 example_type = 'Object';
 java_type = 'Object';
 if(parameters.length>=1) {
  example_type = parameter_types[0].value.toLowerCase();
  if(example_type == "date") { example_type = 'Date'; }
  else if(example_type.indexOf('char')>-1) { example_type = 'String'; }
  else if(example_type == 'int') { example_type = 'Integer'; }
  else if(example_type == 'double') { example_type = 'Double'; }
  else { example_type = example_type.substr(0,1).toUpperCase()+example_type.substr(1); }
  if(example_type == 'Date') { java_type = 'java.sql.Date' } else { java_type = example_type }
 }
 
 
 
 if(scalar_set=="SET") {
  sql += ' do {       // loop over input\n';
  sql += '  '+java_type+' '+parameters[0].value+' = ctx.get'+example_type+'("'+example_input+'");     // access input variable\n';
  sql += ' } while(ctx.next());\n';
 } else if(parameters.length>=1) {
  sql += '  '+java_type+' '+parameters[0].value+' = ctx.get'+example_type+'("'+parameters[0].value+'");     // access input variable\n';
 }
 if(returns_emits=="RETURNS") {
  sql += ' return null;\n';
 } else {
  sql += ' ctx.emit(null'+(', null'.repeat(emits_cols.length-1))+');\n';
 }
 sql += ' }\n';
 sql += '}\n';  
}


sql += '/';

document.getElementById('sql').innerHTML = sql;
}

function add_emit() {
cols = document.getElementsByName('li_emits_cols');

li = document.createElement('li');
li.setAttribute('name', 'li_emits_cols');
li.innerHTML = '<input type="text" name="emits_cols" oninput="generate_sql(this)" placeholder="Column Name"> <input type="text" name="emits_types" list="datatypes" title="Double-click to show some data types" oninput="generate_sql(this)" placeholder="Type"><button onClick="remove_li(this.parentNode)">Remove</button>';
document.getElementById('ul_emits_cols').appendChild(li);
generate_sql(li);
}

function add_parameter() {
parameters = document.getElementsByName('parameter');

li = document.createElement('li');
li.setAttribute('name', 'li_parameter');
li.innerHTML = '<input type="text" name="parameters" oninput="generate_sql(this)" placeholder="Parameter Name"> <input type="text" name="parameter_types" list="datatypes" title="Double-click to show some data types" oninput="generate_sql(this)" placeholder="Type"><button onClick="remove_li(this.parentNode)">Remove</button>';
document.getElementById('ul_parameters').appendChild(li);

document.getElementById('variadic_input').checked = false;

generate_sql(li);
}

function remove_li(obj) {
 obj.parentNode.removeChild(obj);
 generate_sql(obj);
}
</script>
</head>
<body onLoad="generate_sql(this)">
<h1>Exasol UDF-Script Signature Generator</h1>
<textarea style="width:600px" id="sql" rows="12"></textarea>
<ul>
<li>Language: <input type="radio" name="language" id="language_python" oninput="generate_sql(this)" checked>PYTHON <input name="language" type="radio" id="language_lua" oninput="generate_sql(this)">Lua <input type="radio" name="language" id="language_java" oninput="generate_sql(this)">Java <input name="language" type="radio" id="language_r" oninput="generate_sql(this)">R</li> 
<li>Input Type: <input type="radio" name="scalar_set" id="imput_scalar" oninput="generate_sql(this)" checked>SCALAR <input name="scalar_set" type="radio" id="input_set" oninput="generate_sql(this)">SET</li> 
<li>Script Name: <input type="text" id="name" oninput="generate_sql(this)"></input></li>
<li>Input Parameters: <button onClick="add_parameter()">Add</button> <input type="checkbox" id="variadic_input" oninput="generate_sql(this)"/> Variadic
    <ul id="ul_parameters">
    </ul>
</li>
<li>Output Type: <input type="radio" name="returns_emits" id="output_returns" oninput="generate_sql(this)" checked>RETURNS <input name="returns_emits" type="radio" id="output_emits" oninput="generate_sql(this)">EMITS</li></li>
<li id="li_returns">RETURNS: <input type="text" id="returns" list="datatypes" title="Double-click to show some data types" oninput="generate_sql(this)"></input></li>
<li id="li_emits">EMITS: <button onClick="add_emit()">Add</button> <input type="checkbox" id="variadic_output" oninput="generate_sql(this)"/> Variadic
    <ul id="ul_emits_cols">
    <li name="li_emits_cols"><input type="text" name="emits_cols" oninput="generate_sql(this)" placeholder="Column Name"> <input type="text" name="emits_types" list="datatypes" title="Double-click to show some data types" oninput="generate_sql(this)" placeholder="Type"></li>
    </ul>
</li>
</ul>

<datalist id="datatypes">
  <option>INT</option>
  <option>VARCHAR(2000000)</option>
  <option>CHAR(20)</option>
  <option>DATE</option>
  <option>TIMESTAMP</option>
</datalist>

</body>
</html>
